#!/bin/bash --login
#$ -l mem512
#$ -cwd
#$ -t 1-22

# Load any required modulefiles
module load apps/binapps/plink2/20211217
module load apps/gcc/R/4.2.2

# Now the commands to be run by the job

chromosome_analysis () {
	chr=$1
	echo $chr
	numfiles=$(ls -l /mnt/mhs01-home01/KMuir/y78216vh/PRACTICAL_Data/iCOGS/Imputation_1kg_v3/chr$chr/ | grep -v ^d | wc -l)
	i=0
	
	for filename in /mnt/mhs01-home01/KMuir/y78216vh/PRACTICAL_Data/iCOGS/Imputation_1kg_v3/chr$chr/*; do
		((i++))
		echo "File $i of $numfiles"
		echo $filename

		plink2 --keep icogs_cca_pa_bmi_id.csv --gen $filename ref-unknown --sample /mnt/mhs01-home01/KMuir/y78216vh/PRACTICAL_Data/iCOGS/Imputation_1kg_v3/icogs.sample --export bgen-1.3 --chr $chr --oxford-single-chr $chr --out "PLINK_pa_bmi_icogs-$1"
		
		~/software/GEM/GEM_1.5.2_Intel --bgen PLINK_pa_bmi_icogs-$chr.bgen --sample PLINK_pa_bmi_icogs-$chr.sample --pheno-file icogs_cca_pa_bmi_agg.pheno --sampleid-name ID_1 --pheno-name GleasonScore --exposure-names BMI --covar-names pc1_EU pc2_EU pc3_EU pc4_EU pc5_EU pc6_EU pc7_EU --robust 1 --center 0 --missing-value NaN --out "icogs_pa_bmi_agg_GEM_output-$chr.out"

		
		#report results
		Rscript ~/PRACTICAL_Data_Analysis/prs_environment_analysis/12-3/icogs_report_gs.R $chr

		echo $filename

	done
}

chromosome_analysis $SGE_TASK_ID
